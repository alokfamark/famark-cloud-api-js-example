<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Page Info-->
    <title>Famark Cloud API JavaScript Example</title>
    <meta name="description" content="This is a sample code showing how to call Famark Cloud API to store and retrieve data through JavaScript." />
    
    <style type="text/css">
        body {
            font-size: 20px;
            font-family: serif;
        }
        form > div {
            padding: 2px 4px;
        }
        form > div > label {
            display: inline-block;
            width: 160px;
            font-size: 19px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        form > div > input {
            display: inline-block;
            width: 160px;
            font-size: 18px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 1px 5px;
            line-height: 28px;
        }

        form > div > input[type='submit'] {
            width: 339px;
            font-size: 20px;
            height: 36px;
        }

        form.error > div > input {
            color: #f00;
            border: 2px inset #ff0000;
        }

        form.error > span {
            color: #f00;
            clear: both;
            margin: 4px;
            font-size: 16px;
            font-family: serif;
            white-space: nowrap;
        }

        .highlight {
            color: #224466;
        }

        #divRecords {
            display: none;
        }

        #divSessionId {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #headerSessionId {
            color: #0094ff;
            font-size: 12px;
            overflow: inherit;
            text-overflow: inherit;
        }

        table, th, td {
            border: 1px solid #cacaca;
            border-collapse: collapse;
            text-align: left;
            font-size: 14px;
            font-family: sans-serif;
            padding: 3px 6px;
        }
    </style>
</head>
<body>
    <div id="divConnect">
        <h1>Famark Cloud API JavaScript Example</h1>
        <h4>This is a sample code showing how to call Famark Cloud API to store and retrieve data through JavaScript.</h4>
        <h3 class="highlight">NOTE:</h3>
        <h4 class="highlight">Create a UI => Site in your Famark Cloud Domain and upload this HTML file to that Site (from Properties panel on right selecting attachments). Then browse this file from the Site in Famark Cloud; trying to run this script as a local file or on a different host will cause CORS issue.</h4>
        <h4 class="highlight">Register for a <a href="https://www.famark.com/install/?ic=FreePlatform">free tier of famark cloud instance</a> if you do not already have one.</h4>
        <h2>Connect Action <em class="highlight">"/Credential/Connect"</em></h2>
        <form action="#" id="frmLogin">
            <div>
                <label id="dn-label" for="dn">Domain Name</label>
                <input type="text" name="dn" placeholder="Domain Name" />
            </div>
            <div>
                <label id="un-label" for="un">User Name</label>
                <input type="text" name="un" placeholder="User Name" />
            </div>
            <div>
                <label id="pwd-label" for="pwd">Password</label>
                <input type="password" name="pwd" placeholder="Password" />
            </div>
            <div>
                <input name="connectForm" type="submit" class="btn-submit" value="Connect" />
            </div>
        </form>
        <hr />
    </div>
    <div id="divRecords">
        <div id="divSessionId">
            <h4 id="headerSessionId"></h4>
        </div>
        <h2>Profile - Create Record <em class="highlight">"/System_Profile/CreateRecord"</em></h2>
        <form action="#" id="frmCreateProfile">
            <div>
                <label id="dn-label" for="DisplayName">Display Name</label>
                <input type="text" name="DisplayName" placeholder="Display Name" />
            </div>
            <div>
                <label id="un-label" for="SystemName">System Name</label>
                <input type="text" name="SystemName" placeholder="System Name" />
            </div>
            <div>
                <input name="createForm" type="submit" class="btn-submit" value="Create Record" />
            </div>
        </form>
        <hr />
        <h2>Profile - Retrieve Multiple Records <em class="highlight">"/System_Profile/RetrieveMultipleRecords"</em></h2>
        <form action="#" id="frmRetrieveProfiles">
            <div>
                <input name="retrieveForm" type="submit" class="btn-submit" value="Retrieve Multiple Records" />
            </div>
        </form>
        <hr />
    </div>
    <script type="text/javascript">
        var _sessionId = null;
        var frmLogin = document.getElementById("frmLogin");
        frmLogin.addEventListener('submit', frmLoginSubmit);

        function frmLoginSubmit(e) {
            e = e || window.event;
            e.preventDefault();

            var spnMessage = document.body.querySelector('.spnMessage');
            if (spnMessage)
                spnMessage.parentNode.removeChild(spnMessage);

            var nameInputs = [{ "name": "dn", "label": "domain name" }, { "name": "un", "label": "user name" }];

            for (var i = 0; i < nameInputs.length; i++) {
                var item = nameInputs[i];
                var nameInput = frmLogin.elements[item.name];
                var frmMessage = validateAlphaNumeric(nameInput, item.label);

                if (frmMessage) {
                    appendMessageSpan(frmMessage, frmLogin);
                    return;
                }
            }

            var request = {};
            request.DomainName = frmLogin.elements['dn'].value;
            request.UserName = frmLogin.elements['un'].value;
            request.Password = frmLogin.elements['pwd'].value;

            apiPostData('/Credential/Connect', request, null, function (response, errorMessage) {
                if (errorMessage) {
                    appendMessageSpan(errorMessage, frmLogin);
                    frmLogin.className = 'error';
                } else {
                    _sessionId = response;
                    var headerSessionId = document.getElementById('headerSessionId');
                    headerSessionId.innerHTML = "SessionId: " + _sessionId;
                    document.getElementById('divConnect').style.display = 'none';
                    document.getElementById('divRecords').style.display = 'block';
                }
            });
        }

        function validateAlphaNumeric(frmInput, label) {
            if (frmInput.value == '') {
                frmLogin.className = 'error';
                frmInput.focus();
                return 'Enter the ' + label + '!';
            }
            if (frmInput.value.match(/^[a-zA-Z0-9]+$/) == null) {
                frmLogin.className = 'error';
                frmInput.focus();
                return 'Invalid ' + label + ', it must be alphanumeric.';
            }

            frmLogin.className = '';
            frmLogin.parentNode.className = '';
            return null;
        }

        function appendMessageSpan(frmMessage, frmAny) {
            var spnMessage = document.createElement('span');
            spnMessage.className = 'spnMessage';
            frmAny.insertBefore(spnMessage, frmAny.firstChild);
            spnMessage.innerHTML = frmMessage;
            return spnMessage;
        }

        function apiPostData(urlSuffix, request, sessionId, callback) {
            var url = 'https://www.famark.com/Host/api.svc/api' + urlSuffix;

            var strRequest = JSON.stringify(request);

            var http = new XMLHttpRequest();
            http.onload = function () {
                var response = JSON.parse(http.responseText);
                var errorMessage = http.getResponseHeader("ErrorMessage");
                //if response is null then check response header for ErrorMessage
                callback(response, errorMessage);
            };
            http.onerror = function () {
                alert("A network error occurred which could be a CORS issue or a dropped internet connection. Check browser console for more information...");
            };

            http.open("POST", url, true);
            http.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
            http.setRequestHeader("Accept", "application/json; charset=UTF-8");
            if (sessionId)
                http.setRequestHeader("SessionId", sessionId);
            http.send(strRequest);
        }
    </script>

    <!--For Create Record-->
    <script type="text/javascript">
        var frmCreateProfile = document.getElementById("frmCreateProfile");
        frmCreateProfile.addEventListener('submit', frmCreateProfileSubmit);

        function frmCreateProfileSubmit(e) {
            e = e || window.event;
            e.preventDefault();

            var spnMessage = document.body.querySelector('.spnMessage');
            if (spnMessage)
                spnMessage.parentNode.removeChild(spnMessage);

            var dispName = frmCreateProfile.elements['DisplayName'];
            if (dispName.value == '') {
                dispName.focus();
                appendMessageSpan('Enter the display name!', frmCreateProfile);
                return;
            }

            var sysName = frmCreateProfile.elements['SystemName'];
            var frmMessage = validateAlphaNumeric(sysName, 'system name');

            if (frmMessage) {
                appendMessageSpan(frmMessage, frmCreateProfile);
                return;
            }

            var request = {};
            request.DisplayName = dispName.value;
            request.SystemName = sysName.value;

            apiPostData('/System_Profile/CreateRecord', request, _sessionId, function (response, errorMessage) {
                if (errorMessage) {
                    appendMessageSpan(errorMessage, frmCreateProfile);
                    frmCreateProfile.className = 'error';
                } else {
                    appendMessageSpan('Created RecordId: ' + response, frmCreateProfile);
                    frmCreateProfile.className = '';
                }
            });
        }

    </script>

    <!--For Retrieve Multiple Records-->
    <script type="text/javascript">

        var frmRetrieveProfiles = document.getElementById("frmRetrieveProfiles");
        frmRetrieveProfiles.addEventListener('submit', frmRetrieveProfilesSubmit);
        function frmRetrieveProfilesSubmit(e) {
            e = e || window.event;
            e.preventDefault();

            var spnMessage = document.body.querySelector('.spnMessage');
            if (spnMessage)
                spnMessage.parentNode.removeChild(spnMessage);

            var request = {};
            request.Columns = 'DisplayName, SystemName, System_ProfileId';
            request.OrderBy = 'DisplayName';

            apiPostData('/System_Profile/RetrieveMultipleRecords', request, _sessionId, function (response, errorMessage) {
                if (errorMessage) {
                    appendMessageSpan(errorMessage, frmRetrieveProfiles);
                    frmRetrieveProfiles.className = 'error';
                } else {
                    var tbody = getTableBody();
                    frmRetrieveProfiles.className = '';
                    for (var i = 0; i < response.length; i++)
                        tbody.appendChild(getRow(response[i]));
                }
            });
        }

        function getTableBody() {
            var tbody = document.getElementById('tbodyProfiles');
            if (tbody) {
                while (tbody.childNodes.length > 0)
                    tbody.removeChild(tbody.lastChild);
                return tbody;
            }

            var table = document.createElement('table');
            frmRetrieveProfiles.parentNode.appendChild(table);
            var thead = table.appendChild(document.createElement('thead'));
            var headRow = thead.appendChild(document.createElement('tr'));
            headRow.appendChild(document.createElement('th')).innerHTML = 'Display Name';
            headRow.appendChild(document.createElement('th')).innerHTML = 'System Name';
            tbody = table.appendChild(document.createElement('tbody'));
            tbody.id = 'tbodyProfiles';
            return tbody;
        }

        function getRow(record) {
            var tr = document.createElement('tr');
            tr.appendChild(document.createElement('td')).innerHTML = record.DisplayName;
            tr.appendChild(document.createElement('td')).innerHTML = record.SystemName;
            tr.id = record.System_ProfileId;
            return tr;
        }
    </script>
</body>
</html>
